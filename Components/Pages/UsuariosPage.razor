@page "/usuario"
@using System.Net.Http.Json
@using FrontendBlazorApi.Models
@inject IHttpClientFactory fabricaHttp
@rendermode InteractiveServer

<PageTitle>Usuarios</PageTitle>

<h3>Gestión de Usuarios</h3>

<div class="mb-3 d-flex gap-2">
  <button type="button" class="btn btn-outline-primary" @onclick="CargarUsuarios">Mostrar todos</button>
  <button type="button" class="btn btn-outline-dark" @onclick="LimpiarFormulario">Limpiar</button>
</div>

@if (!string.IsNullOrWhiteSpace(mensaje)) { <div class="@claseAviso" role="alert">@mensaje</div> }

<h5 class="mt-2">Buscar</h5>
<div class="row g-2 align-items-end mb-3">
  <div class="col-md-2"><label class="form-label">Id</label><InputNumber class="form-control" @bind-Value="idBusqueda" /></div>
  <div class="col-md-4"><label class="form-label">Email</label><InputText class="form-control" @bind-Value="emailBusqueda" /></div>
  <div class="col-md-6 d-flex gap-2">
    <button type="button" class="btn btn-secondary" @onclick="BuscarPorId">Buscar por Id</button>
    <button type="button" class="btn btn-secondary" @onclick="BuscarPorEmail">Buscar por Email</button>
  </div>
</div>

<h4>Formulario de Usuario</h4>
<EditForm Model="usuarioActual" OnValidSubmit="CrearUsuario" FormName="UsuarioForm">
  <DataAnnotationsValidator /><ValidationSummary />
  <div class="row g-3">
    <div class="col-md-2"><label class="form-label">Id</label><InputNumber class="form-control" @bind-Value="usuarioActual.Id" disabled /></div>
    <div class="col-md-4"><label class="form-label">Email</label><InputText class="form-control" @bind-Value="usuarioActual.Email" /></div>
    <div class="col-md-3"><label class="form-label">Contraseña</label><InputText type="password" class="form-control" @bind-Value="passwordEdicion" /></div>
    <div class="col-md-3"><label class="form-label">Ruta Avatar</label><InputText class="form-control" @bind-Value="usuarioActual.RutaAvatar" /></div>
    <div class="col-md-2 form-check mt-2">
      <InputCheckbox class="form-check-input" @bind-Value="usuarioActual.Activo" />
      <label class="form-check-label">Activo</label>
    </div>
  </div>

  <div class="mt-3 d-flex gap-2">
    <button type="submit" class="btn btn-primary">Crear</button>
    <button type="button" class="btn btn-warning" @onclick="ActualizarUsuario" disabled="@(!existeUsuario)">Actualizar</button>
    <button type="button" class="btn btn-danger" @onclick="EliminarUsuario" disabled="@(!existeUsuario)">Eliminar</button>
  </div>
</EditForm>

<hr />

@if (cargando) { <p><em>Cargando usuarios...</em></p> }
else if (lista.Count == 0) { <p>No hay usuarios.</p> }
else {
<table class="table table-striped">
  <thead><tr><th>Id</th><th>Email</th><th>Activo</th><th>Avatar</th><th>Acciones</th></tr></thead>
  <tbody>
    @foreach (var u in lista)
    {
      <tr>
        <td>@u.Id</td><td>@u.Email</td><td>@(u.Activo ? "Sí" : "No")</td><td>@u.RutaAvatar</td>
        <td><button class="btn btn-sm btn-outline-primary" @onclick="@(() => CargarEnFormulario(u))">Cargar</button></td>
      </tr>
    }
  </tbody>
</table>
}

@code {
  private List<Usuario> lista = new();
  [SupplyParameterFromForm] private Usuario usuarioActual { get; set; } = new();
  private bool existeUsuario = false; private string mensaje=""; private string claseAviso="alert alert-info"; private bool cargando=false;

  private int? idBusqueda; private string emailBusqueda = "";
  private string? passwordEdicion; // Password que escribe el usuario en el form
  private const string urlBaseApi = "api/usuario";

  protected override async Task OnInitializedAsync() => await CargarUsuarios();

  private async Task CargarUsuarios() {
    try {
      cargando = true;
      var cli = fabricaHttp.CreateClient("ApiProductos");
      var resp = await cli.GetFromJsonAsync<RespuestaApiUsuarios<List<Usuario>>>(urlBaseApi);
      lista = resp?.Datos ?? new();
      mensaje = $"Se cargaron {lista.Count} usuario(s)."; claseAviso = "alert alert-success";
    } catch (Exception ex) { mensaje = $"Error al listar: {ex.Message}"; claseAviso = "alert alert-danger"; }
    finally { cargando = false; }
  }

  private async Task BuscarPorId() {
    LimpiarMensajes();
    if (idBusqueda is null || idBusqueda <= 0) { mensaje = "Id inválido."; claseAviso = "alert alert-warning"; return; }
    try {
      var cli = fabricaHttp.CreateClient("ApiProductos");
      var ruta = $"{urlBaseApi}/id/{idBusqueda}";
      var resp = await cli.GetFromJsonAsync<RespuestaApiUsuarios<List<Usuario>>>(ruta);
      var u = resp?.Datos?.FirstOrDefault();
      if (u is not null) { usuarioActual = u; existeUsuario = true; mensaje="Cargado."; claseAviso="alert alert-info"; }
      else { existeUsuario=false; mensaje="No encontrado."; claseAviso="alert alert-warning"; }
    } catch (Exception ex) { existeUsuario=false; mensaje=$"Error al buscar: {ex.Message}"; claseAviso="alert alert-danger"; }
    finally { idBusqueda = null; emailBusqueda = ""; }
  }

  private async Task BuscarPorEmail() {
    LimpiarMensajes();
    if (string.IsNullOrWhiteSpace(emailBusqueda)) { mensaje = "Indique Email."; claseAviso = "alert alert-warning"; return; }
    try {
      var cli = fabricaHttp.CreateClient("ApiProductos");
      var ruta = $"{urlBaseApi}/email/{emailBusqueda}";
      var resp = await cli.GetFromJsonAsync<RespuestaApiUsuarios<List<Usuario>>>(ruta);
      var u = resp?.Datos?.FirstOrDefault();
      if (u is not null) { usuarioActual = u; existeUsuario = true; mensaje="Cargado."; claseAviso="alert alert-info"; }
      else { existeUsuario=false; mensaje="No encontrado."; claseAviso="alert alert-warning"; }
    } catch (Exception ex) { existeUsuario=false; mensaje=$"Error al buscar: {ex.Message}"; claseAviso="alert alert-danger"; }
    finally { idBusqueda = null; emailBusqueda = ""; }
  }

  private async Task CrearUsuario() {
    LimpiarMensajes();
    try {
      var cli = fabricaHttp.CreateClient("ApiProductos");
      // Usa DTO de creación: contraseña obligatoria
      var dto = new UsuarioCreateDto {
        Email = usuarioActual.Email,
        Contrasena = passwordEdicion ?? "",
        RutaAvatar = usuarioActual.RutaAvatar,
        Activo = usuarioActual.Activo
      };
      var resp = await cli.PostAsJsonAsync(urlBaseApi, dto);
      if (resp.IsSuccessStatusCode) { mensaje="Creado."; claseAviso="alert alert-success"; await CargarUsuarios(); LimpiarFormulario(); }
      else { var det = await resp.Content.ReadAsStringAsync(); mensaje=$"No se pudo crear. Detalle: {det}"; claseAviso="alert alert-danger"; }
    } catch (Exception ex) { mensaje=$"Error al crear: {ex.Message}"; claseAviso="alert alert-danger"; }
  }

  private async Task ActualizarUsuario() {
    LimpiarMensajes();
    if (usuarioActual.Id <= 0) { mensaje="Id inválido."; claseAviso="alert alert-warning"; return; }

    try {
      var cli = fabricaHttp.CreateClient("ApiProductos");
      var dto = new UsuarioUpdateDto {
        Email = usuarioActual.Email,
        Contrasena = string.IsNullOrWhiteSpace(passwordEdicion) ? null : passwordEdicion,
        RutaAvatar = usuarioActual.RutaAvatar,
        Activo = usuarioActual.Activo
      };
      var ruta = $"{urlBaseApi}/id/{usuarioActual.Id}";
      var resp = await cli.PutAsJsonAsync(ruta, dto);
      if (resp.IsSuccessStatusCode) { mensaje="Actualizado."; claseAviso="alert alert-success"; await CargarUsuarios(); usuarioActual = new(); existeUsuario=false; passwordEdicion = null; }
      else { var det = await resp.Content.ReadAsStringAsync(); mensaje=$"No se pudo actualizar. Detalle: {det}"; claseAviso="alert alert-danger"; }
    } catch (Exception ex) { mensaje=$"Error al actualizar: {ex.Message}"; claseAviso="alert alert-danger"; }
  }

  private async Task EliminarUsuario() {
    LimpiarMensajes();
    if (usuarioActual.Id <= 0) { mensaje="Id inválido."; claseAviso="alert alert-warning"; return; }
    try {
      var cli = fabricaHttp.CreateClient("ApiProductos");
      var ruta = $"{urlBaseApi}/id/{usuarioActual.Id}";
      var resp = await cli.DeleteAsync(ruta);
      if (resp.IsSuccessStatusCode) { mensaje="Eliminado."; claseAviso="alert alert-success"; await CargarUsuarios(); LimpiarFormulario(); }
      else { var det = await resp.Content.ReadAsStringAsync(); mensaje=$"No se pudo eliminar. Detalle: {det}"; claseAviso="alert alert-danger"; }
    } catch (Exception ex) { mensaje=$"Error al eliminar: {ex.Message}"; claseAviso="alert alert-danger"; }
  }

  private void CargarEnFormulario(Usuario u) { usuarioActual = u; existeUsuario = true; mensaje="Seleccionado."; claseAviso="alert alert-info"; }
  private void LimpiarMensajes() { mensaje = ""; claseAviso = "alert alert-info"; }
  private void LimpiarFormulario() { usuarioActual = new(); existeUsuario=false; idBusqueda=null; emailBusqueda=""; passwordEdicion=null; LimpiarMensajes(); }
}
