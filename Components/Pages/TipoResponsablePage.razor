@page "/tipoResponsable"

@using System.Net.Http.Json
@using System.Linq
@using FrontendBlazorApi.Models
@inject IHttpClientFactory fabricaHttp
@rendermode InteractiveServer

<PageTitle>Tipo de Responsable</PageTitle>

<h3>Gestión de Tipos de Responsable</h3>

<div class="mb-3 d-flex gap-2">
    <button type="button" class="btn btn-outline-secondary" @onclick="ProbarConexion">Probar conexión</button>
    <button type="button" class="btn btn-outline-primary" @onclick="CargarItems">Mostrar todos</button>
    <button type="button" class="btn btn-outline-dark" @onclick="LimpiarFormulario">Limpiar</button>
</div>

@if (!string.IsNullOrWhiteSpace(mensaje))
{
    <div class="@claseAviso" role="alert">@mensaje</div>
}

<h5 class="mt-2">Buscar</h5>
<div class="row g-2 align-items-end mb-3">
    <div class="col-md-2">
        <label class="form-label">Id</label>
        <InputNumber class="form-control" @bind-Value="idBusqueda" />
    </div>
    <div class="col-md-4">
        <label class="form-label">Título</label>
        <InputText class="form-control" @bind-Value="tituloBusqueda" />
    </div>
    <div class="col-md-6 d-flex gap-2">
        <button type="button" class="btn btn-secondary" @onclick="BuscarPorId">Buscar por Id</button>
        <button type="button" class="btn btn-secondary" @onclick="BuscarPorTitulo">Buscar por Título</button>
    </div>
</div>

<h4>Formulario</h4>

<EditForm Model="itemActual" OnValidSubmit="CrearItem" FormName="TipoResponsableForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="row g-3">
        <div class="col-md-2">
            <label class="form-label">Id</label>
            <InputNumber class="form-control" @bind-Value="itemActual.Id" disabled />
        </div>

        <div class="col-md-4">
            <label class="form-label">Título</label>
            <InputText class="form-control" @bind-Value="itemActual.Titulo" />
        </div>

        <div class="col-md-6">
            <label class="form-label">Descripción</label>
            <InputText class="form-control" @bind-Value="itemActual.Descripcion" />
        </div>
    </div>

    <div class="mt-3 d-flex flex-wrap gap-2">
        <button type="submit" class="btn btn-primary">Crear</button>
        <button type="button" class="btn btn-warning" @onclick="ActualizarItem" disabled="@(!existeItem)">Actualizar</button>
        <button type="button" class="btn btn-danger" @onclick="EliminarItem" disabled="@(!existeItem)">Eliminar</button>
    </div>
</EditForm>

<hr />

@if (cargando)
{
    <p><em>Cargando...</em></p>
}
else if (lista.Count == 0)
{
    <p>No hay registros.</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Id</th>
                <th>Título</th>
                <th>Descripción</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (FrontendBlazorApi.Models.TipoResponsable it in lista)
            {
                <tr>
                    <td>@it.Id</td>
                    <td>@it.Titulo</td>
                    <td>@it.Descripcion</td>
                    <td>
                        <button type="button"
                                class="btn btn-sm btn-outline-primary"
                                @onclick="() => CargarEnFormulario(it)">
                            Cargar
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
@if (existeItem)
{
    <!-- ===================== RESPONSABLES ASOCIADOS ===================== -->
    <hr />
    <h5>Responsables del tipo: @itemActual.Titulo</h5>

    <EditForm Model="responsableActual" OnValidSubmit="CrearOActualizarResponsable">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="row g-2 mb-3">
            <div class="col-md-3">
                <label>Usuario</label>
                <select class="form-select" @bind="responsableActual.IdUsuario">
                    <option value="">Seleccione...</option>
                    @foreach (var u in usuarios)
                    {
                        <option value="@u.Id">@u.Email</option>
                    }
                </select>
            </div>

            <div class="col-md-5">
                <label>Nombre</label>
                <InputText class="form-control" @bind-Value="responsableActual.Nombre" />
            </div>

            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-outline-primary w-100">
                    @(existeResponsable ? "Actualizar" : "Agregar")
                </button>
            </div>

            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger w-100" 
                        @onclick="EliminarResponsable" 
                        disabled="@(!existeResponsable)">
                    Eliminar
                </button>
            </div>
        </div>
    </EditForm>

    @if (responsablesAsociados.Count == 0)
    {
        <p>No hay responsables asociados a este tipo.</p>
    }
    else
    {
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Usuario</th>
                    <th>Nombre</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in responsablesAsociados)
                {
                    <tr>
                        <td>@r.Id</td>
                        <td>@usuarios.FirstOrDefault(u => u.Id == r.IdUsuario)?.Email</td>
                        <td>@r.Nombre</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary"
                                    @onclick="() => CargarEnFormularioResponsable(r)">
                                Cargar
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}


@code {
    private List<FrontendBlazorApi.Models.TipoResponsable> lista = new List<FrontendBlazorApi.Models.TipoResponsable>();

    [SupplyParameterFromForm]
    private FrontendBlazorApi.Models.TipoResponsable itemActual { get; set; } = new FrontendBlazorApi.Models.TipoResponsable();

    private bool existeItem = false;
    private string mensaje = "";
    private string claseAviso = "alert alert-info";
    private bool cargando = false;

    private int? idBusqueda;
    private string tituloBusqueda = "";

    private const string urlBaseApi = "api/tiporesponsable";

    // === RESPONSABLES ASOCIADOS ===
    private List<Usuario> usuarios = new();
    private List<Responsable> responsablesAsociados = new();
    private Responsable responsableActual = new();
    private bool existeResponsable = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarItems();
    }

    private async Task CargarItems()
    {
        try
        {
            cargando = true;
            var cliente = fabricaHttp.CreateClient("ApiProductos");
            var resp = await cliente.GetFromJsonAsync<RespuestaApiTipoResponsable<List<FrontendBlazorApi.Models.TipoResponsable>>>(urlBaseApi);
            lista = resp?.Datos ?? new List<FrontendBlazorApi.Models.TipoResponsable>();
            mensaje = $"Se cargaron {lista.Count} registro(s).";
            claseAviso = "alert alert-success";
        }
        catch (Exception ex)
        {
            mensaje = $"Error al listar: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
        finally { cargando = false; }
    }

    private async Task BuscarPorId()
    {
        LimpiarMensajes();

        if (idBusqueda is null || idBusqueda <= 0)
        {
            mensaje = "Debe indicar un Id válido para buscar.";
            claseAviso = "alert alert-warning";
            return;
        }

        try
        {
            var cli = fabricaHttp.CreateClient("ApiProductos");
            var ruta = $"{urlBaseApi}/id/{idBusqueda}";
            var resp = await cli.GetFromJsonAsync<RespuestaApiTipoResponsable<List<FrontendBlazorApi.Models.TipoResponsable>>>(ruta);
            var encontrado = resp?.Datos?.FirstOrDefault();

            if (encontrado != null)
            {
                itemActual = new FrontendBlazorApi.Models.TipoResponsable
                {
                    Id = encontrado.Id,
                    Titulo = encontrado.Titulo,
                    Descripcion = encontrado.Descripcion
                };
                existeItem = true;
                mensaje = "Registro cargado. Usa 'Actualizar' para guardar cambios.";
                claseAviso = "alert alert-info";
            }
            else
            {
                existeItem = false;
                mensaje = "No encontrado.";
                claseAviso = "alert alert-warning";
            }
        }
        catch (Exception ex)
        {
            existeItem = false;
            mensaje = $"Error al buscar: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
        finally
        {
            idBusqueda = null;
            tituloBusqueda = "";
        }
    }

    private async Task BuscarPorTitulo()
    {
        LimpiarMensajes();

        if (string.IsNullOrWhiteSpace(tituloBusqueda))
        {
            mensaje = "Debe indicar el Título para buscar.";
            claseAviso = "alert alert-warning";
            return;
        }

        try
        {
            var cli = fabricaHttp.CreateClient("ApiProductos");
            var ruta = $"{urlBaseApi}/titulo/{tituloBusqueda}";
            var resp = await cli.GetFromJsonAsync<RespuestaApiTipoResponsable<List<FrontendBlazorApi.Models.TipoResponsable>>>(ruta);
            var encontrado = resp?.Datos?.FirstOrDefault();

            if (encontrado != null)
            {
                itemActual = new FrontendBlazorApi.Models.TipoResponsable
                {
                    Id = encontrado.Id,
                    Titulo = encontrado.Titulo,
                    Descripcion = encontrado.Descripcion
                };
                existeItem = true;
                mensaje = "Registro cargado. Usa 'Actualizar' para guardar cambios.";
                claseAviso = "alert alert-info";
            }
            else
            {
                existeItem = false;
                mensaje = "No encontrado.";
                claseAviso = "alert alert-warning";
            }
        }
        catch (Exception ex)
        {
            existeItem = false;
            mensaje = $"Error al buscar: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
        finally
        {
            idBusqueda = null;
            tituloBusqueda = "";
        }
    }

    private async Task CrearItem()
    {
        LimpiarMensajes();

        try
        {
            var cli = fabricaHttp.CreateClient("ApiProductos");
            itemActual.Id = 0; // identity
            var resp = await cli.PostAsJsonAsync(urlBaseApi, itemActual);

            if (resp.IsSuccessStatusCode)
            {
                mensaje = "Creado correctamente.";
                claseAviso = "alert alert-success";
                await CargarItems();
                LimpiarFormulario();
            }
            else
            {
                var det = await resp.Content.ReadAsStringAsync();
                mensaje = $"No se pudo crear. Detalle: {det}";
                claseAviso = "alert alert-danger";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error al crear: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task ActualizarItem()
    {
        LimpiarMensajes();

        if (itemActual.Id <= 0)
        {
            mensaje = "Id inválido para actualizar.";
            claseAviso = "alert alert-warning";
            return;
        }

        try
        {
            var cli = fabricaHttp.CreateClient("ApiProductos");
            var dto = new { titulo = itemActual.Titulo, descripcion = itemActual.Descripcion };
            var ruta = $"{urlBaseApi}/id/{itemActual.Id}";
            var resp = await cli.PutAsJsonAsync(ruta, dto);

            if (resp.IsSuccessStatusCode)
            {
                mensaje = "Actualizado correctamente.";
                claseAviso = "alert alert-success";
                await CargarItems();

                itemActual = new FrontendBlazorApi.Models.TipoResponsable();
                existeItem = false;
            }
            else
            {
                var det = await resp.Content.ReadAsStringAsync();
                mensaje = $"No se pudo actualizar. Detalle: {det}";
                claseAviso = "alert alert-danger";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error al actualizar: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task EliminarItem()
    {
        LimpiarMensajes();

        if (itemActual.Id <= 0)
        {
            mensaje = "Id inválido para eliminar.";
            claseAviso = "alert alert-warning";
            return;
        }

        try
        {
            var cli = fabricaHttp.CreateClient("ApiProductos");
            var ruta = $"{urlBaseApi}/id/{itemActual.Id}";
            var resp = await cli.DeleteAsync(ruta);

            if (resp.IsSuccessStatusCode)
            {
                mensaje = "Eliminado correctamente.";
                claseAviso = "alert alert-success";
                await CargarItems();
                LimpiarFormulario();
            }
            else
            {
                var det = await resp.Content.ReadAsStringAsync();
                mensaje = $"No se pudo eliminar. Detalle: {det}";
                claseAviso = "alert alert-danger";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error al eliminar: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task CargarEnFormulario(TipoResponsable it)
    {
        itemActual = it;
        existeItem = true;
        mensaje = $"Tipo seleccionado: {it.Titulo}";
        claseAviso = "alert alert-info";

        await CargarResponsablesPorTipo(it.Id);
    }



    private void LimpiarMensajes() { mensaje = ""; claseAviso = "alert alert-info"; }

    private void LimpiarFormulario()
    {
        itemActual = new FrontendBlazorApi.Models.TipoResponsable();
        existeItem = false;
        idBusqueda = null;
        tituloBusqueda = "";
        LimpiarMensajes();
    }

    private async Task ProbarConexion()
    {
        LimpiarMensajes();

        try
        {
            var cli = fabricaHttp.CreateClient("ApiProductos");
            var r = await cli.GetAsync(urlBaseApi);

            if (r.IsSuccessStatusCode)
            {
                mensaje = "Conexión con la API verificada.";
                claseAviso = "alert alert-success";
            }
            else
            {
                mensaje = $"La API respondió con estado {(int)r.StatusCode}.";
                claseAviso = "alert alert-warning";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error de conexión a la API: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
    }
        // === RESPONSABLES ===
    private async Task CargarUsuarios()
    {
        var cli = fabricaHttp.CreateClient("ApiProductos");
        var resp = await cli.GetFromJsonAsync<RespuestaApiUsuarios<List<Usuario>>>("api/usuario");
        usuarios = resp?.Datos ?? new();
    }

    private async Task CargarResponsablesPorTipo(int idTipo)
    {
        var cli = fabricaHttp.CreateClient("ApiProductos");
        var resp = await cli.GetFromJsonAsync<RespuestaApiResponsable<List<Responsable>>>("api/responsable");
        var todos = resp?.Datos ?? new();
        responsablesAsociados = todos.Where(r => r.IdTipoResponsable == idTipo).ToList();
    }


    private async Task CrearOActualizarResponsable()
    {
        var cli = fabricaHttp.CreateClient("ApiProductos");

        responsableActual.IdTipoResponsable = itemActual.Id;

        var datos = new Dictionary<string, object?>
        {
            { "IdTipoResponsable", responsableActual.IdTipoResponsable },
            { "IdUsuario", responsableActual.IdUsuario },
            { "Nombre", responsableActual.Nombre }
        };

        HttpResponseMessage resp;

        if (existeResponsable)
            resp = await cli.PutAsJsonAsync($"api/responsable/id/{responsableActual.Id}", datos);
        else
            resp = await cli.PostAsJsonAsync("api/responsable", datos);

        if (resp.IsSuccessStatusCode)
        {
            mensaje = "Responsable guardado correctamente.";
            claseAviso = "alert alert-success";
            await CargarResponsablesPorTipo(itemActual.Id);
            responsableActual = new();
            existeResponsable = false;
        }
        else
        {
            mensaje = "Error al guardar responsable.";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task EliminarResponsable()
    {
        if (responsableActual.Id <= 0) return;

        var cli = fabricaHttp.CreateClient("ApiProductos");
        var resp = await cli.DeleteAsync($"api/responsable/{responsableActual.Id}");

        if (resp.IsSuccessStatusCode)
        {
            mensaje = "Responsable eliminado correctamente.";
            claseAviso = "alert alert-success";
            await CargarResponsablesPorTipo(itemActual.Id);
            responsableActual = new();
            existeResponsable = false;
        }
        else
        {
            var detalle = await resp.Content.ReadAsStringAsync();

            if (detalle.Contains("REFERENCE constraint"))
            {
                mensaje = "No se puede eliminar el responsable porque está asociado a entregables u otros registros.";
            }
            else
            {
                mensaje = $"Error al eliminar responsable: {detalle}";
            }

            claseAviso = "alert alert-danger";
        }
    }


    private void CargarEnFormularioResponsable(Responsable it)
    {
        responsableActual = new Responsable
        {
            Id = it.Id,
            IdTipoResponsable = it.IdTipoResponsable,
            IdUsuario = it.IdUsuario,
            Nombre = it.Nombre
        };
        existeResponsable = true;
        mensaje = "Responsable cargado para edición.";
        claseAviso = "alert alert-info";
    }

    private void LimpiarResponsable()
    {
        responsableActual = new();
        existeResponsable = false;
    }

}
